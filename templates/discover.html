{% extends "base.html" %} {% block title %}Discover - JF-Resolve{% endblock %}
{% block content %}
<script>
    // Protect this page - require authentication
    if (!window.isAuthenticated()) {
        window.location.href = "/login";
    }
</script>
<div x-data="discoverPage()">
    <!-- Hero Section (Slideshow) -->
    <div class="relative w-full h-[70vh] min-h-[500px] mb-8 rounded-2xl overflow-hidden shadow-2xl group"
        x-show="heroItems.length > 0">
        <template x-for="(item, index) in heroItems" :key="item.tmdb_id">
            <div class="absolute inset-0 transition-opacity duration-1000 ease-in-out" x-show="heroIndex === index"
                x-transition:enter="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="opacity-100"
                x-transition:leave-end="opacity-0">
                <!-- Backdrop -->
                <img :src="'https://image.tmdb.org/t/p/original' + (item.backdrop_path || item.poster_path)"
                    class="w-full h-full object-cover" :alt="item.title" />

                <!-- Gradient Overlay -->
                <div class="absolute inset-0 bg-gradient-to-r from-base-300 via-base-300/80 to-transparent"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-base-300 via-transparent to-transparent"></div>

                <!-- Content -->
                <div class="absolute inset-0 flex items-end px-6 md:px-12 pb-12 md:pb-16">
                    <div class="max-w-2xl space-y-4">
                        <div class="badge badge-primary badge-lg mb-2"
                            x-text="item.media_type === 'tv' ? 'Series' : 'Movie'"></div>
                        <h1 class="text-2xl md:text-5xl font-extrabold text-white drop-shadow-lg leading-tight"
                            x-text="item.title">
                        </h1>
                        <div class="flex items-center gap-4 text-sm font-medium text-gray-200">
                            <span x-text="item.year"></span>
                            <span>•</span>
                            <span class="flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path
                                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <span x-text="Math.round(item.vote_average * 10) / 10"></span>
                            </span>
                        </div>
                        <p class="text-sm md:text-lg text-gray-300 line-clamp-3 leading-relaxed drop-shadow-md"
                            x-text="item.overview"></p>

                        <div class="flex gap-3 pt-4">
                            <button class="btn btn-primary" x-show="!item.in_library" @click="showDetail(item)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add to Library
                            </button>
                            <div class="badge badge-success badge-lg h-12 px-4" x-show="item.in_library">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7" />
                                </svg>
                                In Library
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Navigation Buttons -->
        <div class="absolute bottom-6 right-8 flex gap-2 z-10">
            <template x-for="(item, index) in heroItems" :key="index">
                <button class="w-3 h-3 rounded-full transition-all"
                    :class="heroIndex === index ? 'bg-primary w-8' : 'bg-white/30 hover:bg-white/50'"
                    @click="setHero(index)"></button>
            </template>
        </div>
    </div>

    <h1 class="text-3xl font-bold mb-6">Discover</h1>

    <!-- Movies - Popular -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4">Movies - Popular</h2>
        <div class="carousel-container flex gap-3 overflow-x-auto pb-4">
            <template x-for="item in popularMovies" :key="item.tmdb_id">
                <div class="media-card cursor-pointer flex-none w-32 sm:w-36 md:w-40" @click="showDetail(item)">
                    <div class="card bg-base-100 shadow-xl h-full">
                        <figure class="aspect-[2/3]">
                            <img :src="getPosterUrl(item.poster_path)" :alt="item.title"
                                class="w-full h-full object-cover" />
                        </figure>
                        <div class="card-body p-2">
                            <h3 class="card-title text-xs line-clamp-2 min-h-[2rem]" x-text="item.title"></h3>
                            <p class="text-xs opacity-70" x-text="item.year"></p>
                            <div class="badge badge-xs w-full justify-center mt-1"
                                :class="item.in_library ? 'badge-success' : 'badge-ghost'"
                                x-text="item.in_library ? '✓ In Library' : '+ Add'"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div x-show="loading.popularMovies" class="text-center py-4">
            <span class="loading loading-spinner"></span>
        </div>
    </div>

    <!-- Series - Popular -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4">Series - Popular</h2>
        <div class="carousel-container flex gap-3 overflow-x-auto pb-4">
            <template x-for="item in popularTV" :key="item.tmdb_id">
                <div class="media-card cursor-pointer flex-none w-32 sm:w-36 md:w-40" @click="showDetail(item)">
                    <div class="card bg-base-100 shadow-xl h-full">
                        <figure class="aspect-[2/3]">
                            <img :src="getPosterUrl(item.poster_path)" :alt="item.title"
                                class="w-full h-full object-cover" />
                        </figure>
                        <div class="card-body p-2">
                            <h3 class="card-title text-xs line-clamp-2 min-h-[2rem]" x-text="item.title"></h3>
                            <p class="text-xs opacity-70" x-text="item.year"></p>
                            <div class="badge badge-xs w-full justify-center mt-1"
                                :class="item.in_library ? 'badge-success' : 'badge-ghost'"
                                x-text="item.in_library ? '✓ In Library' : '+ Add'"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div x-show="loading.popularTV" class="text-center py-4">
            <span class="loading loading-spinner"></span>
        </div>
    </div>

    <!-- Movies - Top Rated -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4">Movies - Top Rated</h2>
        <div class="carousel-container flex gap-3 overflow-x-auto pb-4">
            <template x-for="item in topRatedMovies" :key="item.tmdb_id">
                <div class="media-card cursor-pointer flex-none w-32 sm:w-36 md:w-40" @click="showDetail(item)">
                    <div class="card bg-base-100 shadow-xl h-full">
                        <figure class="aspect-[2/3]">
                            <img :src="getPosterUrl(item.poster_path)" :alt="item.title"
                                class="w-full h-full object-cover" />
                        </figure>
                        <div class="card-body p-2">
                            <h3 class="card-title text-xs line-clamp-2 min-h-[2rem]" x-text="item.title"></h3>
                            <p class="text-xs opacity-70" x-text="item.year"></p>
                            <div class="badge badge-xs w-full justify-center mt-1"
                                :class="item.in_library ? 'badge-success' : 'badge-ghost'"
                                x-text="item.in_library ? '✓ In Library' : '+ Add'"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div x-show="loading.topRatedMovies" class="text-center py-4">
            <span class="loading loading-spinner"></span>
        </div>
    </div>

    <!-- Series - Top Rated -->
    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4">Series - Top Rated</h2>
        <div class="carousel-container flex gap-3 overflow-x-auto pb-4">
            <template x-for="item in topRatedTV" :key="item.tmdb_id">
                <div class="media-card cursor-pointer flex-none w-32 sm:w-36 md:w-40" @click="showDetail(item)">
                    <div class="card bg-base-100 shadow-xl h-full">
                        <figure class="aspect-[2/3]">
                            <img :src="getPosterUrl(item.poster_path)" :alt="item.title"
                                class="w-full h-full object-cover" />
                        </figure>
                        <div class="card-body p-2">
                            <h3 class="card-title text-xs line-clamp-2 min-h-[2rem]" x-text="item.title"></h3>
                            <p class="text-xs opacity-70" x-text="item.year"></p>
                            <div class="badge badge-xs w-full justify-center mt-1"
                                :class="item.in_library ? 'badge-success' : 'badge-ghost'"
                                x-text="item.in_library ? '✓ In Library' : '+ Add'"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        <div x-show="loading.topRatedTV" class="text-center py-4">
            <span class="loading loading-spinner"></span>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" :class="selectedItem ? 'modal-open' : ''" @click.self="selectedItem = null">
        <div class="modal-box max-w-4xl p-0" x-show="selectedItem">
            <button class="btn btn-sm btn-circle absolute right-2 top-2 z-10" @click="selectedItem = null">
                ✕
            </button>
            <template x-if="selectedItem">
                <div>
                    <!-- Backdrop Image -->
                    <div class="relative h-64 overflow-hidden">
                        <img :src="'https://image.tmdb.org/t/p/w1280' + (selectedItem.backdrop_path || selectedItem.poster_path)"
                            :alt="selectedItem.title" class="w-full h-full object-cover" />
                        <div class="absolute inset-0 bg-gradient-to-t from-base-100 to-transparent"></div>
                        <div class="absolute bottom-4 left-6">
                            <h3 class="font-bold text-3xl text-white drop-shadow-lg" x-text="selectedItem.title"></h3>
                            <p class="text-sm opacity-90 text-white drop-shadow" x-text="selectedItem.year"></p>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-6">
                        <p class="mb-4" x-text="selectedItem.overview"></p>

                        <div class="form-control"
                            x-show="!selectedItem.in_library && selectedItem.media_type === 'movie'">
                            <label class="label"><span class="label-text font-semibold">Quality Versions</span></label>
                            <div class="flex gap-2 mb-4">
                                <label class="cursor-pointer flex items-center gap-2">
                                    <input type="checkbox" class="checkbox checkbox-sm" value="4k"
                                        x-model="selectedQualities" />
                                    <span>4K</span>
                                </label>
                                <label class="cursor-pointer flex items-center gap-2">
                                    <input type="checkbox" class="checkbox checkbox-sm" value="1080p"
                                        x-model="selectedQualities" />
                                    <span>1080p</span>
                                </label>
                                <label class="cursor-pointer flex items-center gap-2">
                                    <input type="checkbox" class="checkbox checkbox-sm" value="720p"
                                        x-model="selectedQualities" />
                                    <span>720p</span>
                                </label>
                                <label class="cursor-pointer flex items-center gap-2">
                                    <input type="checkbox" class="checkbox checkbox-sm" value="unknown"
                                        x-model="selectedQualities" />
                                    <span>Any (Unknown)</span>
                                </label>
                            </div>
                        </div>

                        <div x-show="!selectedItem.in_library && selectedItem.media_type === 'tv'">
                            <div class="divider">Library Sync</div>
                            <p class="text-sm opacity-70 mb-4">
                                Adding this series will create a single .strm file per episode.
                                The resolution will be determined by your global quality preference.
                            </p>
                        </div>

                        <div class="modal-action">
                            <button class="btn" @click="selectedItem = null">
                                Close
                            </button>
                            <button class="btn btn-primary" @click="addToLibrary()"
                                :disabled="adding || selectedItem.in_library" x-show="!selectedItem.in_library">
                                <span x-show="!adding">Add to Library</span>
                                <span x-show="adding" class="loading loading-spinner"></span>
                            </button>
                            <span class="badge badge-success" x-show="selectedItem.in_library">Already in Library</span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" :class="showSuccessModal ? 'modal-open' : ''" @click.self="showSuccessModal = false">
        <div class="modal-box text-center">
            <div class="flex justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-success" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="font-bold text-2xl mb-2">Success!</h3>
            <p class="mb-6" x-text="successMessage"></p>
            <div class="modal-action justify-center">
                <button class="btn btn-primary" @click="showSuccessModal = false">
                    OK
                </button>
            </div>
        </div>
    </div>
    <!-- Generic Modal (Error/Alert) -->
    <div class="modal" :class="modal.isOpen ? 'modal-open' : ''" @click.self="closeModal()">
        <div class="modal-box">
            <h3 class="font-bold text-lg" x-text="modal.title"></h3>
            <p class="py-4" x-text="modal.message"></p>
            <div class="modal-action">
                <button class="btn btn-primary" @click="closeModal()">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
    function discoverPage() {
        return {
            // Hero State
            heroItems: [],
            heroIndex: 0,
            heroInterval: null,

            popularMovies: [],
            popularTV: [],
            topRatedMovies: [],
            topRatedTV: [],
            selectedItem: null,
            selectedQualities: ["1080p"],
            adding: false,
            showSuccessModal: false,
            successMessage: "",
            // Modal State
            modal: {
                isOpen: false,
                type: 'alert',
                title: '',
                message: '',
                confirmLabel: 'OK',
            },
            loading: {
                popularMovies: false,
                popularTV: false,
                topRatedMovies: false,
                topRatedTV: false,
            },

            async init() {
                // Load all sections in parallel
                await Promise.all([
                    this.loadPopularMovies(),
                    this.loadPopularTV(),
                    this.loadTopRatedMovies(),
                    this.loadTopRatedTV(),
                ]);

                // Initialize Hero Items (Top 5 popular movies)
                if (this.popularMovies.length > 0) {
                    this.heroItems = this.popularMovies.slice(0, 5);
                    this.startHeroRotation();
                }
            },

            showAlert(title, message) {
                this.modal = {
                    isOpen: true,
                    type: 'alert',
                    title,
                    message,
                    confirmLabel: 'OK',
                };
            },

            closeModal() {
                this.modal.isOpen = false;
            },

            startHeroRotation() {
                if (this.heroInterval) clearInterval(this.heroInterval);
                this.updateGlobalBackground(); // Initial set
                this.heroInterval = setInterval(() => {
                    this.heroIndex = (this.heroIndex + 1) % this.heroItems.length;
                    this.updateGlobalBackground();
                }, 8000); // 8 seconds per slide
            },

            updateGlobalBackground() {
                if (this.heroItems.length > 0) {
                    const item = this.heroItems[this.heroIndex];
                    const bgUrl = 'https://image.tmdb.org/t/p/original' + (item.backdrop_path || item.poster_path);
                    window.dispatchEvent(new CustomEvent('update-background', { detail: bgUrl }));
                }
            },

            setHero(index) {
                this.heroIndex = index;
                this.startHeroRotation(); // Reset timer on manual interaction
            },

            async loadPopularMovies() {
                this.loading.popularMovies = true;
                try {
                    const response = await fetch(
                        "/api/discover/popular/movies",
                    );
                    const data = await response.json();
                    this.popularMovies = data.results || [];
                } catch (error) {
                    console.error("Failed to load popular movies:", error);
                    this.popularMovies = [];
                } finally {
                    this.loading.popularMovies = false;
                }
            },

            async loadPopularTV() {
                this.loading.popularTV = true;
                try {
                    const response = await fetch("/api/discover/popular/tv");
                    const data = await response.json();
                    this.popularTV = data.results || [];
                } catch (error) {
                    console.error("Failed to load popular TV:", error);
                    this.popularTV = [];
                } finally {
                    this.loading.popularTV = false;
                }
            },

            async loadTopRatedMovies() {
                this.loading.topRatedMovies = true;
                try {
                    const response = await fetch(
                        "/api/discover/top-rated/movies",
                    );
                    const data = await response.json();
                    this.topRatedMovies = data.results || [];
                } catch (error) {
                    console.error("Failed to load top rated movies:", error);
                    this.topRatedMovies = [];
                } finally {
                    this.loading.topRatedMovies = false;
                }
            },

            async loadTopRatedTV() {
                this.loading.topRatedTV = true;
                try {
                    const response = await fetch("/api/discover/top-rated/tv");
                    const data = await response.json();
                    this.topRatedTV = data.results || [];
                } catch (error) {
                    console.error("Failed to load top rated TV:", error);
                    this.topRatedTV = [];
                } finally {
                    this.loading.topRatedTV = false;
                }
            },

            getPosterUrl(path) {
                return path
                    ? `https://image.tmdb.org/t/p/w500${path}`
                    : "/static/placeholder.png";
            },

            async showDetail(item) {
                this.selectedItem = item;
                if (item.media_type === 'movie') {
                    const settings = await fetch('/api/settings/').then(r => r.json());
                    this.selectedQualities = settings.settings.quality_versions || ["1080p"];
                } else {
                    this.selectedQualities = ["auto"];
                }
            },

            async addToLibrary() {
                if (this.selectedItem.media_type === 'movie' && this.selectedQualities.length === 0) {
                    this.showAlert("Validation Error", "Please select at least one quality version for the movie.");
                    return;
                }

                const qualities = this.selectedItem.media_type === 'tv' ? ["auto"] : this.selectedQualities;

                this.adding = true;
                try {
                    const token = localStorage.getItem("authToken");
                    const headers = {
                        "Content-Type": "application/json",
                    };
                    if (token) {
                        headers["Authorization"] = `Bearer ${token}`;
                    }

                    const response = await fetch("/api/library/add", {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            tmdb_id: this.selectedItem.tmdb_id,
                            media_type: this.selectedItem.media_type,
                            quality_versions: qualities,
                            added_via: "discover",
                        }),
                    });

                    if (response.ok) {
                        const itemTitle = this.selectedItem.title;
                        this.successMessage = `"${itemTitle}" has been added to your library!`;
                        this.selectedItem = null;
                        this.showSuccessModal = true;
                        // Reload all sections to update library status
                        await Promise.all([
                            this.loadPopularMovies(),
                            this.loadPopularTV(),
                            this.loadTopRatedMovies(),
                            this.loadTopRatedTV(),
                        ]);
                    } else {
                        const error = await response.json();
                        this.showAlert("Error", "Error: " + error.detail);
                    }
                } catch (e) {
                    this.showAlert("Error", "Failed to add to library: " + e.message);
                } finally {
                    this.adding = false;
                }
            },
        };
    }
</script>

<style>
    [x-cloak] {
        display: none !important;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
{% endblock %}